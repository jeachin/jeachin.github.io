<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>小C的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="小C的博客">
<meta property="og:url" content="https://mrxccc.github.io/page/4/index.html">
<meta property="og:site_name" content="小C的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="mrxccc">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="小C的博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">小C的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://mrxccc.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-从服务化到云原生-配置" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/2fab00f3.html" class="article-date">
  <time class="dt-published" datetime="2020-11-23T07:38:59.000Z" itemprop="datePublished">2020-11-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8C%96%E5%88%B0%E4%BA%91%E5%8E%9F%E7%94%9F/">从服务化到云原生</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/2fab00f3.html">从服务化到云原生-配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>配置（Configguration）对于每个工程师来说都不陌生，相信没有哪个系统是不提供配置参数的。</p>
<p>本文讲解由单机应用的本地配置向分布式应用的配置中心演进过程，以及配置中心的一些核心概念</p>
<h2 id="1-本地配置"><a href="#1-本地配置" class="headerlink" title="1 本地配置"></a>1 本地配置</h2><p>在集中式系统架构的单机应用时代，配置大多数通过属性文件的形式存储以<code>Key=Value</code>的形态出现。当然也有使用XML或YAML等更加复杂的方式进行配置（比如Spring的配置文件application.xml）但开发工程师更倾向于将他们归类为代码部分，真正可以动态修改的配置应该是简单、易于理解的、易于修改的。</p>
<p>在单机时代，配置文件就够用了。运维工程师如果想修改配置，登录生产机器，用VIM本文编辑，然后重启应用，或者用定时任务从新加载配置文件就可以生效。</p>
<h2 id="2-配置集中化"><a href="#2-配置集中化" class="headerlink" title="2 配置集中化"></a>2 配置集中化</h2><p>服务器增加导致运维工作量增加，分布式系统很难使用本地配置。采用集中化的方式，也就是散落在每台服务器上运维操作集中于一点统一处理，然后程序通过远程通信或异步消息分发到各个服务器。对系统配置进行修改是运维工程师的重要工作之一，所以对配置进行统一管理是大势所趋。</p>
<p><strong>本地配置存在的问题：</strong></p>
<ul>
<li>　配置工作量大；</li>
<li>　配置修改遗漏，导致各个节点配置环境不一致；</li>
<li>　各个节点配置不一致的时间差长（各个服务器操作时间不同）；</li>
<li>　配置修改无法动态生效（定时重新加载或重启应用）；</li>
<li>　直接修改配置文本信息产生错误难于校验；</li>
</ul>
<p><strong>配置中心能解决上述问题，还能提供额外的便利：</strong></p>
<ul>
<li>　配置工作量少，单点修改，全局生效；</li>
<li>　配置修改不容易遗漏；</li>
<li>　各个节点配置不一致的时间差比较短；</li>
<li>　配置信息可以像业务数据一样被持久化保存，方便恢复，方便搭建环境，方便最终修改历史；</li>
<li>多个系统上线时，配置检查、沟通协调容易；</li>
<li>　配置信息放置于应用程序之外，更容易保持应用的无状态化，为容器化和微服务化部署方案提供了强有力的支持。</li>
</ul>
<h2 id="3-配置值中心和注册中心"><a href="#3-配置值中心和注册中心" class="headerlink" title="3 配置值中心和注册中心"></a>3 配置值中心和注册中心</h2><p>很多人认为配置中心和注册中心是可以相互替换的两个同义词，因为他们的使用场景非相似。另外，当前很多开源产品，如zookeeper、etcd等，都同时支持这两种场景，这也更加容易让人误以为他们就是同一事物。但事实上，他们还是有着本质区别的。</p>
<p>注册中心与配置中心的关注点不完全相同。注册中心用于分布式系统的服务质量，多用于管理运行在当前集群中的服务的状态，需要随时进行动态更新。而配置中心则不然，它关注的是配置本身，相比于状态，配置是更加静态和具象的事物。配置的三个要素是快速传播、变更稀疏、环境相关</p>
<blockquote>
<p>快速传播：分布式场景下，各个服务节点都需要得到一致的数据，无论是配置还是状态，一旦发生改变往往要求集群中的所有节点同时感知变更</p>
<p>变更稀疏：配置发生变更的情况非常少，因此配置中心对读性能进行优化，而对写要求稍低</p>
<p>环境相关：一般耳熟能详的系统环境有开发环境、测试环境、线上环境，不同的环境对应着不同的配置，但注册中心所关注的应用程序的运行状态和环境是没有任何关系</p>
</blockquote>
<h3 id="3-1-读性能"><a href="#3-1-读性能" class="headerlink" title="3.1 读性能"></a>3.1 读性能</h3><p>采用配置中心方案后，就必须要考虑远程调用导致的性能下降和配置中心本身的单节点访问压力的问题</p>
<p>解决方案：缓存。</p>
<p>因为配置信息是可穷举的，不可能是海量的，所以一次性杯加载进本地缓存是非常方便的</p>
<p>缓存分为位于配置中心的集中式缓存和位于应用端的本地缓存</p>
<ul>
<li><p><strong>集中式缓存</strong>：配置信息读远大于写。每次读取磁盘影响性能，缓存到内存。</p>
<ul>
<li>优点：能访问最新的数据，数据一致性好，提升访问效率；</li>
<li>缺点：没有缓解配置中心的访问压力。</li>
</ul>
</li>
<li><p><strong>本地缓存</strong>：客户端缓存，尽量访问本地，只有在配置发生变化的时候才读配置中心，更新缓存。</p>
<ul>
<li>优点：减少远程调用，提升访问效率，缓解了配置中心压力。</li>
<li>缺点：数据存在多份，可能不一致。</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>补充：</strong></p>
<p>缓存击穿：缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中时需要从数据库查询，查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到数据库去查询，造成缓存穿透。在流量大时，可能DB就挂掉了，要是有人利用不存在的key频繁攻击我们的应用，这就是漏洞，缓存还有可能降低效率； </p>
</blockquote>
<h3 id="3-2-变更实时性"><a href="#3-2-变更实时性" class="headerlink" title="3.2 变更实时性"></a>3.2 变更实时性</h3><p>如果使用本地缓存，数据就会存在多个副本，配置中心数据发生变更时，如何将配置信息实时通知给应用客户端。</p>
<p>一般有两种方式：<strong>监听</strong>和<strong>实时同步</strong></p>
<ul>
<li>监听：配置中心的客户端都需要与配置中心建立长连接。配置变化时，配置变化了，主动推送各个客户端，客户端更新缓存。<ul>
<li>优点：实时性高；</li>
<li>缺点： 长连接比较消耗系统资源。并且长连接一旦断了，还要从新连接，容错等。</li>
</ul>
</li>
</ul>
<blockquote>
<p>保持长连接有效的方法是：心跳监听服务，一旦发现连接不可用则销毁连接建立新连接。为了保证应用客户端能正确接收到信息变更请求，也需要让客户端给予反馈，不反馈就一直发。客户端要实现<strong>幂等性（在应答式通信系统中，可能存存在多发请求的情况； 比如kafka重复消费数据）</strong>。　</p>
</blockquote>
<ul>
<li>实时同步：客户端主动定时去询问配置中心。如果发现缓存和配置中心不一致，就更新缓存。这样使用短连接就可以。</li>
<li>优点：节省连接资源，降低服务中心的压力。</li>
<li>缺点：间隔时间长，则配置更新不及时；间隔时间短，则配置中心压力过大，并且做很多无用功。</li>
</ul>
<blockquote>
<p><strong>其他方法</strong>；设置缓存失效时间。　  </p>
</blockquote>
<h3 id="3-3-可用性"><a href="#3-3-可用性" class="headerlink" title="3.3 可用性"></a>3.3 可用性</h3><p>配置中心是整个分布式系统的核心，一旦配置中心不可用，整个系统将会受到极大影响</p>
<p>那么如何提升配置中心的可用性呢？服务冗余、缓存</p>
<ul>
<li><p>服务冗余：做服务集群，数据备份</p>
<ul>
<li>1 基于主节点提供服务：主从模式，主节点提供服务，从节点冗余数据备份</li>
<li>2 基于对等节点提供服务：节点对等，在访问量非常大的情况下可以有效分流（但对于配置中心，有点小题大做）</li>
</ul>
</li>
<li><p>缓存：也是服务冗余的一种，但只是冗余数据，而不是整个服务</p>
<ul>
<li>优点：提升读取配置信息的性能，可以在配置中心节点全失效时提供应急使用，也叫离线模式。</li>
<li>缺点：缓存更新不了了。</li>
</ul>
</li>
</ul>
<p>　</p>
<h3 id="3-4-数据一致性"><a href="#3-4-数据一致性" class="headerlink" title="3.4 数据一致性"></a>3.4 数据一致性</h3><p>分布式架构下，数据一致性如何保证</p>
<p><strong>一致性三种方案</strong>：</p>
<ul>
<li><p><strong>ACID（</strong>强一致性）</p>
</li>
<li><p><strong>BASE</strong>：BASE是<strong>Basically Available(基本可用，</strong>响应时间上有损失，功能有损失<strong>）</strong>、<strong>Soft state(软状态，</strong>软状态是指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同的数据副本之间进行数据同步的过程存在延时<strong>）</strong>和<strong>Eventually consistent(最终一致性，</strong>最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状<strong>）</strong>三个短语的简写。 其核心思  想是即使无法做到强一致性，但每个应用都可以根据自身的业务特点，采用适当的方法来使系统达到<strong>最终一致性。</strong>最终一致性是一种特殊的弱一致性：系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问都能够获取到最新的值。同时，在没有发生故障的前提下，数据到达一致状态的时间延迟，取决于网络延迟、系统负载和数据复制方案设计等因素。</p>
</li>
<li><p><strong>状态机</strong>：状态机是表示实体的状态根据条件转移的数学模型。通过状态机模型，系统可以判断当前不一致状态，以及如何校正不一致状态到一致状态；</p>
</li>
<li><p>基于状态机的数据一致性算法是：ZAB和Raft</p>
</li>
<li><p>成熟的产品有zookeeper（基于ZAB算法）；etcd（基于Raft算法）和Consul(基于Raft算法)</p>
</li>
</ul>
<p>那么配置中心选择哪种方案更加合适呢？</p>
<p>配置中心并不需要ACID的事物，也不会有类似于关系型数据库那一复杂跨表的关联操作；对于BASE的最终一致性的柔性事物场景而言，一致性状态没有时间的保证，因此也不适合用于处理相对敏感的配置信息；通过状态机保证数据一致性的处理方式，无论是在一致性还是性能上，都更加适合配置中心。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/2fab00f3.html" data-id="cm5kxt8o9002tkku41gzi9j32" data-title="从服务化到云原生-配置" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E9%9D%A2/" rel="tag">知识面</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-设计模式-抽象工厂模式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/5a86ebac.html" class="article-date">
  <time class="dt-published" datetime="2020-11-21T02:33:12.000Z" itemprop="datePublished">2020-11-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/5a86ebac.html">设计模式-抽象工厂模式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在前面介绍的<a href="https://mrxccc.github.io/posts/89a20157.html">工厂方法模式</a>是考虑的一类产品的生产，如手机工厂只生产手机，也就是说，工厂方法模式只考虑生产同等级产品，但是在现实生活中，许多工厂是综合型的工厂，手机工厂不仅仅只生产手机，还生产耳机、手机壳、充电宝等等</p>
<p>本节要介绍的抽象工厂模式将考虑多等级产品的生产，将同一个具体工厂所生产的位于不同等级的一组产品称为一个产品族</p>
<blockquote>
<p>抽象工厂模式与工厂方法模式最大的区别：抽象工厂中每个工厂可以创建多种类的产品；而工厂方法每个工厂只能创建一类</p>
</blockquote>
<h2 id="1-模式介绍"><a href="#1-模式介绍" class="headerlink" title="1 模式介绍"></a>1 模式介绍</h2><h3 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h3><p>抽象工厂（AbstractFactory）模式的定义：是一种为访问类提供一个创建一组相关或相互依赖对象的接口，且访问类无须指定所要产品的具体类就能得到同族的不同等级的产品的模式结构。</p>
<h3 id="1-2-模式组成"><a href="#1-2-模式组成" class="headerlink" title="1.2 模式组成"></a>1.2 模式组成</h3><p>抽象工厂模式的主要角色如下。</p>
<table>
<thead>
<tr>
<th>组成（角色）</th>
<th>关系</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td>抽象产品（Product）</td>
<td>具体产品的父类</td>
<td align="center">描述具体产品的公共接口</td>
</tr>
<tr>
<td>具体产品（Concrete Product）</td>
<td>抽象产品的子类；工厂类创建的目标类</td>
<td align="center">描述生产的具体产品</td>
</tr>
<tr>
<td>抽象工厂（Creator）</td>
<td>具体工厂的父类</td>
<td align="center">描述具体工厂的公共接口</td>
</tr>
<tr>
<td>具体工厂（Concrete Creator）</td>
<td>抽象工厂的子类；被外界调用</td>
<td align="center">描述具体工厂；实现FactoryMethod工厂方法创建产品的实例</td>
</tr>
</tbody></table>
<p><img src="/img/abstractFactory-uml.png"></p>
<p>从图上面的图可以看出抽象工厂模式的结构同工厂方法模式的结构相似，不同的是其产品的种类不止一个，所以创建产品的方法也不止一个。</p>
<h3 id="1-3-解决的问题"><a href="#1-3-解决的问题" class="headerlink" title="1.3 解决的问题"></a>1.3 解决的问题</h3><p>解决工厂方法模式的缺点</p>
<blockquote>
<p>每增加一个产品就要增加一个具体产品类和一个对应的具体工厂类，这增加了系统的复杂度，工厂方法可以解决这一问题</p>
</blockquote>
<h2 id="2-实例讲解："><a href="#2-实例讲解：" class="headerlink" title="2 实例讲解："></a>2 实例讲解：</h2><p>继续<a href="https://mrxccc.github.io/posts/89a20157.html">工厂方法模式</a>中手机专卖店<code>Store</code>卖手机的例子，不了解的可以去看看<a href="https://mrxccc.github.io/posts/89a20157.html">工厂方法模式</a>中手机专卖店的例子。目前<code>Store</code>卖有两种手机，一个苹果手机，一个索尼手机，此时客户需要买耳机，那么专卖店就必须要进货，采购不同厂商品牌的耳机（苹果耳机、索尼耳机）。那么就必须要新增耳机工厂（苹果耳机工厂、索尼耳机工厂），而且还是不同品牌的耳机，假如后面又增加了一个品牌（比如小米）的手机、耳机、充电器、手机壳，此时使用工厂方法模式就要增加小米手机工厂、耳机工厂、充电器工厂、手机壳工厂，想想对这一大堆工厂的管理就很麻烦，那么使用抽象工厂模式就能解决这种问题</p>
<h3 id="2-1-使用步骤"><a href="#2-1-使用步骤" class="headerlink" title="2.1 使用步骤"></a>2.1 使用步骤</h3><p>步骤1： 创建抽象产品类 ，定义具体产品的公共抽象接口；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 耳机</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Headset</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 品牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String brand;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Phone</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 品牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String brand;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作系统</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String os;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 充电</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">charge</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOs</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> os;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOs</span><span class="params">(String os)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.os = os;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤2： 创建抽象工厂类，定义具体工厂的公共接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 这里和工厂方法模式不同，定义了同一等级的不同产品</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    Phone <span class="title function_">getPhone</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Headset <span class="title function_">getHeadset</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤3：创建具体工厂类（继承抽象工厂类），定义创建对应具体产品实例的方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 苹果工厂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppleFactory</span> <span class="keyword">implements</span> <span class="title class_">Factory</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApplePhone <span class="title function_">getPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplePhone</span> <span class="variable">applePhone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplePhone</span>();</span><br><span class="line">        applePhone.setBrand(<span class="string">&quot;Apple&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> applePhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AppleHeadset <span class="title function_">getHeadset</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AppleHeadset</span> <span class="variable">appleHeadset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppleHeadset</span>();</span><br><span class="line">        appleHeadset.setBrand(<span class="string">&quot;Apple&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> appleHeadset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 索尼工厂</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SonyFactory</span> <span class="keyword">extends</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SonyPhone <span class="title function_">getPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SonyPhone</span> <span class="variable">sonyPhone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SonyPhone</span>();</span><br><span class="line">        sonyPhone.setBrand(<span class="string">&quot;Sony&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sonyPhone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SonyHeadset <span class="title function_">getHeadset</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SonyHeadset</span> <span class="variable">sonyHeadset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SonyHeadset</span>();</span><br><span class="line">        sonyHeadset.setBrand(<span class="string">&quot;Sony&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sonyHeadset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤4： 创建抽象产品类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Phone</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 品牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String brand;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作系统</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String os;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 充电</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">charge</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOs</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> os;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOs</span><span class="params">(String os)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.os = os;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 耳机</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Headset</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 品牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String brand;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤5： 创建具体产品类（继承抽象产品类）， 定义生产的具体产品；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 苹果手机</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplePhone</span> <span class="keyword">extends</span> <span class="title class_">Phone</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">charge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;普通充电&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 索尼手机</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SonyPhone</span> <span class="keyword">extends</span> <span class="title class_">Phone</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">charge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;快充&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 苹果耳机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppleHeadset</span> <span class="keyword">extends</span> <span class="title class_">Headset</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Apple 耳机播放逻辑 ...</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Apple 耳机播放完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 索尼耳机</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SonyHeadset</span> <span class="keyword">extends</span> <span class="title class_">Headset</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Sony 耳机播放逻辑...</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Sony 耳机播放完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤6：外界通过调用具体工厂类的方法，从而创建不同具体产品类的实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 专卖店D：抽象工厂模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mrxccc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020/9/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StoreD</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Factory factory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StoreD</span><span class="params">(Factory factory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 补充手机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">supplyPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Phone</span> <span class="variable">phone</span> <span class="operator">=</span> factory.getPhone();</span><br><span class="line">        <span class="comment">// 补充手机逻辑...</span></span><br><span class="line">        System.out.println(<span class="string">&quot;补充&quot;</span> + phone.getBrand() + <span class="string">&quot;手机完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 补充耳机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">supplyHeadset</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Headset</span> <span class="variable">headset</span> <span class="operator">=</span> factory.getHeadset();</span><br><span class="line">        <span class="comment">// 补充耳机逻辑...</span></span><br><span class="line">        System.out.println(<span class="string">&quot;补充&quot;</span> + headset.getBrand() + <span class="string">&quot;耳机完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StoreD</span> <span class="variable">storeC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StoreD</span>(<span class="keyword">new</span> <span class="title class_">SonyFactory</span>());</span><br><span class="line">        storeC.supplyPhone();</span><br><span class="line">        storeC.supplyHeadset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">补充Sony手机完成</span><br><span class="line">补充Sony耳机完成</span><br></pre></td></tr></table></figure>

<h2 id="3-应用场景"><a href="#3-应用场景" class="headerlink" title="3.应用场景"></a>3.应用场景</h2><p>抽象工厂模式最早的应用是用于创建属于不同操作系统的视窗构件。如java 的 AWT 中的 Button 和 Text 等构件在 Windows 和 UNIX 中的本地实现是不同的。</p>
<p>抽象工厂模式通常适用于以下场景：</p>
<ol>
<li>当需要创建的对象是一系列相互关联或相互依赖的产品族时，如电器工厂中的电视机、洗衣机、空调等。</li>
<li>系统中有多个产品族，但每次只使用其中的某一族产品。如有人只喜欢穿某一个品牌的衣服和鞋。</li>
<li>系统中提供了产品的类库，且所有产品的接口相同，客户端不依赖产品实例的创建细节和内部结构。</li>
</ol>
<h2 id="4-模式扩展"><a href="#4-模式扩展" class="headerlink" title="4.模式扩展"></a>4.模式扩展</h2><p>抽象工厂模式的扩展有一定的“开闭原则”倾斜性：</p>
<ol>
<li>当增加一个新的产品族（<code>是产品族，不是某个产品</code>）时只需增加一个新的具体工厂，不需要修改原代码，满足开闭原则。</li>
<li>当产品族中需要增加一个新种类的产品时，则所有的工厂类都需要进行修改，不满足开闭原则。</li>
</ol>
<p>另一方面，当系统中只存在一个等级结构的产品时，抽象工厂模式将退化到工厂方法模式。</p>
<p>源码：<a target="_blank" rel="noopener" href="https://github.com/mrxccc/DesignPatterns">设计模式</a></p>
<blockquote>
<p>其他设计模式介绍：</p>
<p><a href="https://mrxccc.github.io//posts/89a20157.html">设计模式-工厂方法模式</a></p>
<p><a href="https://mrxccc.github.io//posts/5a86ebac.html">设计模式-抽象工厂模式</a></p>
<p><a href="https://mrxccc.github.io//posts/2a48474d.html">设计模式-建造者模式</a></p>
</blockquote>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/5a86ebac.html" data-id="cm5kxt8oi003kkku4d2htagoq" data-title="设计模式-抽象工厂模式" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Gitlab Runner的安装配置" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/52649bb.html" class="article-date">
  <time class="dt-published" datetime="2020-11-03T04:57:44.000Z" itemprop="datePublished">2020-11-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/gitlab-ci/">gitlab-ci</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/52649bb.html">Gitlab Runner的安装与配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Runner"><a href="#Runner" class="headerlink" title="Runner"></a>Runner</h2><p>Runner就像一个个的工人，而Gitlab-CI就是这些工人的一个管理中心，所有工人都要在Gitlab-CI里面登记注册，并且表明自己是为哪个工程服务的。当相应的工程发生变化时，Gitlab-CI就会通知相应的工人执行软件集成脚本。如下图所示：</p>
<p><img src="/img/gitlab-runner.png"></p>
<p>gitlab里面的runner叫<code>Gitlab-Runner</code>，Gitlab-Runner是配合Gitlab-CI进行使用的。一般地，Gitlab里面的每一个工程都会定义一个属于这个工程的软件集成脚本，用来自动化地完成一些软件集成工作。当这个工程的仓库代码发生变动时，比如有人push了代码，GitLab就会将这个变动通知Gitlab-CI。这时Gitlab-CI会找出与这个工程相关联的Runner，并通知这些Runner把代码更新到本地并执行预定义好的执行脚本(也就是在<code>Job执行流程</code>那个图中所示的第三步：script)，所以，Gitlab-Runner就是一个用来执行软件集成脚本<code>script</code>的东西。</p>
<p>Runner类型</p>
<p>Gitlab-Runner可以分类两种类型：<strong>Shared Runner（共享型）</strong>和<strong>Specific Runner（指定型）</strong>。</p>
<ul>
<li><strong>Shared Runner：</strong>这种Runner（工人）是所有工程都能够用的。只有系统管理员能够创建Shared Runner。</li>
<li><strong>Specific Runner：</strong>这种Runner（工人）只能为指定的工程服务。拥有该工程访问权限的人都能够为该工程创建Shared Runner。</li>
</ul>
<h3 id="什么情况下需要注册Shared-Runner？"><a href="#什么情况下需要注册Shared-Runner？" class="headerlink" title="什么情况下需要注册Shared Runner？"></a>什么情况下需要注册Shared Runner？</h3><ol>
<li>比如，GitLab上面所有的工程都有可能需要在公司的服务器上进行编译、测试、部署等工作，这个时候注册一个Shared Runner供所有工程使用就很合适。</li>
</ol>
<h3 id="什么情况下需要注册Specific-Runner？"><a href="#什么情况下需要注册Specific-Runner？" class="headerlink" title="什么情况下需要注册Specific Runner？"></a>什么情况下需要注册Specific Runner？</h3><ol>
<li>比如，我可能需要在我个人的电脑或者服务器上自动构建我参与的某个工程，这个时候注册一个Specific Runner就很合适。</li>
</ol>
<h3 id="Runner搭建"><a href="#Runner搭建" class="headerlink" title="Runner搭建"></a>Runner搭建</h3><p>  1、linux操作系统，安装docker环境。（如果安装了devops，docker环境可以不用安装）</p>
<p>  2、安装gitlab-runner</p>
<h4 id="1-Runner-安装"><a href="#1-Runner-安装" class="headerlink" title="1. Runner 安装"></a>1. Runner 安装</h4><p>在<code>GitLab Runner 10</code>之前，gitlab-runner的名称叫<code>gitlab-ci-multi-runner</code>,安装命令如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># For Debian/Ubuntu</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.deb.sh | <span class="built_in">sudo</span> bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># For RHEL/CentOS</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | <span class="built_in">sudo</span> bash</span><br></pre></td></tr></table></figure>

<p>在<code>GitLab Runner 10</code>及其以上，可执行文件已重命名为<code>gitlab-runner</code>。</p>
<p>linux系统，可以通过以下命令安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># For Debian/Ubuntu/Mint</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | <span class="built_in">sudo</span> bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># For RHEL/CentOS/Fedora</span></span><br><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | <span class="built_in">sudo</span> bash</span><br></pre></td></tr></table></figure>

<p>如果要安装特定版本的GitLab Runner：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for DEB based systems</span></span><br><span class="line">apt-cache madison gitlab-runner</span><br><span class="line"><span class="built_in">export</span> GITLAB_RUNNER_DISABLE_SKEL=<span class="literal">true</span>; <span class="built_in">sudo</span> -E apt-get install gitlab-runner=10.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># for RPM based systems</span></span><br><span class="line">yum list gitlab-runner --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line"><span class="built_in">export</span> GITLAB_RUNNER_DISABLE_SKEL=<span class="literal">true</span>; <span class="built_in">sudo</span> -E yum install gitlab-runner-10.0.0-1</span><br></pre></td></tr></table></figure>

<p>授予其执行权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/gitlab-runner</span><br></pre></td></tr></table></figure>

<p>创建一个GitLab CI用户：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd --comment &#x27;GitLab Runner&#x27; --create-home gitlab-runner --shell /bin/bash</span><br></pre></td></tr></table></figure>

<p>安装并作为服务运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner</span><br><span class="line">sudo gitlab-runner start</span><br></pre></td></tr></table></figure>

<h4 id="2-获取Runner注册Token"><a href="#2-获取Runner注册Token" class="headerlink" title="2. 获取Runner注册Token"></a>2. 获取Runner注册Token</h4><p>安装好Runner之后，需要向Gitlab进行注册，注册Runner需要GitLab-CI的url和token。可根据需求注册选择所需类型Runner。这里介绍spercific runners为例</p>
<p><img src="/img/gitlab-ci-runner.png"></p>
<p>图中的Url和Token是runner链接到仓库的两个重要参数</p>
<h4 id="3-runner配置"><a href="#3-runner配置" class="headerlink" title="3.runner配置"></a>3.runner配置</h4><p>执行注册runner的命令(如果你是安装的<code>gitlab-ci-multi-runner</code>)：<code>sudo gitlab-ci-multi-runner register</code></p>
<p>执行注册runner的命令(如果你是安装的<code>gitlab-runner</code>)：<code>sudo gitlab-runner register</code></p>
<p>接下来会提示你输入一系列配置内容</p>
<blockquote>
<p>注意，在要求输入<code>tag</code>时，想好tag的名字，这个就相当于你的runner的id</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">## 输入url</span><br><span class="line">a、Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com )</span><br><span class="line"> </span><br><span class="line">## 输入token</span><br><span class="line">b、Please enter the gitlab-ci token for this runner</span><br><span class="line"> </span><br><span class="line">## 写个描述</span><br><span class="line">c、Please enter the gitlab-ci description for this runner</span><br><span class="line"> </span><br><span class="line">## 这个tag很重要，好好想个名字并记住，随后在ci配置中需要对应上。</span><br><span class="line">d、Please enter the gitlab-ci tags for this runner (comma separated)</span><br><span class="line"> </span><br><span class="line">## ci没有配置tags时是否执行这个runner？建议采用默认值。            </span><br><span class="line">e、Whether to run untagged builds [true/false]</span><br><span class="line"> </span><br><span class="line">## 是否只对当前工程有效？理论上讲只有“Shared runners”才有效。选true。            </span><br><span class="line">f、Whether to lock Runner to current project [true/false]</span><br><span class="line"> </span><br><span class="line">## 选择一个执行器。我们接来下的方案是基于shell的，输入shell。    </span><br><span class="line">g、Please enter the executor: virtualbox, docker+machine, kubernetes, parallels, docker-ssh, shell, ssh, docker-ssh+machine, docker:</span><br></pre></td></tr></table></figure>

<p>注册完成后，会出现一个runner，我这里注册了两个，所以会有两个tag</p>
<blockquote>
<p>runner 左边会有一个<code>小绿点</code>，表示该runner是能正常执行的</p>
</blockquote>
<p><img src="/img/gitlab-runner-regist.png" alt="image-20201103104204166"></p>
<h4 id="Gitlab-runner的配置"><a href="#Gitlab-runner的配置" class="headerlink" title="Gitlab-runner的配置"></a>Gitlab-runner的配置</h4><p>GitLab-CI会为这个Runner生成一个唯一的token，以后Runner就通过这个token与GitLab-CI进行通信。</p>
<p>那么，问题来了。注册好了的Runner的信息存放在哪儿了呢？</p>
<p>原来，Runner的信息是存放在一个配置文件里面的，配置文件的格式一般是.toml。这个配置文件的存放位置有以下几种情况：</p>
<ul>
<li>在类Unix操作系统下（0.5.0之后版本）<ul>
<li>如果是以root用户身份运行gitlab-runner register，那么配置文件默认是&#x2F;etc&#x2F;gitlab-runner&#x2F;config.toml</li>
<li>如果是以非root用户身份运行gitlab-runner register，那么配置文件默认是~&#x2F;.gitlab-runner&#x2F;config.toml</li>
</ul>
</li>
<li>在其他操作系统下以及0.5.0之前版本</li>
</ul>
<p>配置文件默认在当前工作目录下.&#x2F;config.toml</p>
<p>一般情况下，使用默认的配置文件存放Runner的配置信息就可以了。当然，如果你有更细化的分类需求，你也可以在注册的时候通过-c或–config选项指定配置文件的位置。具体查看register命令的使用方法：<code>gitlab-runner register --help</code>。</p>
<p><strong>问题：</strong>如果不运行<code>gitlab-runner register</code>命令，直接在配置文件里面添加Runner的配置信息可以吗？</p>
<p><strong>回答：</strong>当然不可以。因为gitlab-ci-runner register的作用除了把Runner的信息保存到配置文件以外，还有一个很重要的作用，那就是向GitLab-CI发出请求，在GitLab-CI中登记这个Runner的信息并且获取后续通信所需要的token。</p>
<h2 id="让注册好的Runner运行起来"><a href="#让注册好的Runner运行起来" class="headerlink" title="让注册好的Runner运行起来"></a>让注册好的Runner运行起来</h2><p>Runner注册完成之后还不行，还必须让它运行起来，否则它无法接收到GitLab-CI的通知并且执行软件集成脚本。怎么让Runner运行起来呢？gitlab-runner提供了这样一条命令gitlab-runner run-single</p>
<p>以上的就是在linux机器上直接安装runner的过程，关于gitlab ci怎么使用runner执行我们想要执行的任务，可参考这篇文章：</p>
<p><a href="https://mrxccc.github.io/posts/66a907b1.html">Gitlab-CICD最简单明了的入门教程</a></p>
<p>使用docker安装gitlab runner：<a href="https://mrxccc.github.io/posts/66a907b1.html">Gitlab Runner的容器化安装与使用</a></p>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/52649bb.html" data-id="cm5kxt8nk000skku49j3d6ziu" data-title="Gitlab Runner的安装与配置" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Gitlab-runner的容器化安装与使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/7a7080f.html" class="article-date">
  <time class="dt-published" datetime="2020-11-03T04:57:44.000Z" itemprop="datePublished">2020-11-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/gitlab-ci/">gitlab-ci</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/7a7080f.html">Gitlab-runner的容器化安装与使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>gitlab-runner有多种安装方式，具体详见 <a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/install/index.html">gitlab-runner安装</a> ，本文采用的docker的方式进行runner的部署</p>
<h2 id="为什么用docker安装gitlab-runner"><a href="#为什么用docker安装gitlab-runner" class="headerlink" title="为什么用docker安装gitlab-runner?"></a>为什么用docker安装gitlab-runner?</h2><ul>
<li>1.runner机器经常改变</li>
<li>2.每个作业都处于干净的环境中，没有过去的历史记录。并发任务执行正常，因为每个构建都有自己的 Docker 引擎实例，因此它们不会相互冲突</li>
</ul>
<h2 id="开始安装："><a href="#开始安装：" class="headerlink" title="开始安装："></a>开始安装：</h2><p>前提安装好docker环境</p>
<h3 id="1-创建并启动gitlab-runner容器"><a href="#1-创建并启动gitlab-runner容器" class="headerlink" title="1.创建并启动gitlab-runner容器"></a>1.创建并启动gitlab-runner容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker run -d --name gitlab-runner --restart always   </span><br><span class="line">    -v /var/run/docker.sock:/var/run/docker.sock   </span><br><span class="line">    -v /srv/gitlab-runner/config:/etc/gitlab-runner   </span><br><span class="line">    -v /home/gitlab-runner/shell:/home/gitlab-runner/shell   </span><br><span class="line">    -v /root/build_cache:/cache   gitlab/gitlab-runner:latest</span><br></pre></td></tr></table></figure>

<p>注：</p>
<ol>
<li>第一个 -v 实现docker.sock的挂载（因为后续要实现docker in docker的使用，即 docker executor）；</li>
<li>第二个 -v 实现gitlab-runner的配置挂载（可选）</li>
<li>第三个 -v 实现gitlab-runner cache目录的挂载（可选），cache相关请参考 docker executor 下的cache部分。</li>
<li>第四个 -v 实现本地shell目录挂载（可选）</li>
</ol>
<p>修改gitlab-runner时区为宿主机时区，因为有可能在gitlab-容器中使用到时间，可以执行该命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker cp /etc/localtime gitlab-runner:/etc/localtime</span><br></pre></td></tr></table></figure>

<h3 id="2-注册runner"><a href="#2-注册runner" class="headerlink" title="2.注册runner"></a>2.注册runner</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker exec gitlab-runner gitlab-runner register -n \</span><br><span class="line">       --url https://git-pd.megvii-inc.com/ \</span><br><span class="line">       --registration-token qZXDG-z3uPGvsVn-5SNx \</span><br><span class="line">       --tag-list runInDk \</span><br><span class="line">       --executor docker \</span><br><span class="line">       --docker-image mrxccc/maven-jdk8-docker:latest  \</span><br><span class="line">       --docker-volumes /root/.m2:/root/.m2 \</span><br><span class="line">       --docker-volumes /root/.npm:/root/.npm \</span><br><span class="line">       --docker-volumes /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">       --docker-volumes /home/gitlab-runner/shell:/home/gitlab-runner/shell \</span><br><span class="line">       --description &quot;runInDk&quot;</span><br></pre></td></tr></table></figure>

<p>注：</p>
<ul>
<li>url 为 gitlab的地址；</li>
<li>registration-token 为项目下的token，可通过 gitlab -&gt; project -&gt; settings -&gt; ci&#x2F;cd 下获得</li>
<li>executor，使用 docker 作为 executor;</li>
<li>description 为 runner 的描述信息，请自定义；</li>
<li>docker-image 为 executor 所采用的自己构建的 docker 镜像，该镜像有maven、java、docker、bash环境（会被gitlab-ci.yml中的配置覆盖）。</li>
<li>docker-volumes ，因采用 “docker executor” ，必须挂载宿主机的docker.sock，</li>
<li>挂载.m2文件夹，是为了避免maven每次编译项目时都重新下载jar包。（后面.gitlab-ci.yml文件中使用了maven镜像）</li>
</ul>
<blockquote>
<p>挂载.m2文件夹这一步很重要，不然每次下载依赖包会特别浪费时间</p>
<p>如果想要在docker in docker,也就是在docker容器中使用宿主机的docker，要挂载docker.sock文件，关于为什么要挂载docker.sock，可以参考这篇文章：<a href="https://mrxccc.github.io/4d3646a8.html">docker系列-docker.sock探究</a></p>
</blockquote>
<p>mrxccc&#x2F;maven-jdk8-docker镜像的dockerfile:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.6</span>.<span class="number">0</span>-jdk-<span class="number">8</span>-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> mrxccc@qq.com</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="comment">#安装docker</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> http://dl-cdn.alpinelinux.org/alpine/latest-stable/community &gt;&gt; /etc/apk/repositories &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">        apk update &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">        apk add docker --no-cache &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">        apk add openrc --no-cache</span></span><br><span class="line"><span class="comment">#设置时区</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache tzdata &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/cache/apk/*</span></span><br><span class="line"><span class="comment">#安装sudo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add <span class="built_in">sudo</span> --no-cache</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> service docker start</span></span><br></pre></td></tr></table></figure>

<h3 id="3-编写gitlab-ci"><a href="#3-编写gitlab-ci" class="headerlink" title="3.编写gitlab-ci"></a>3.编写gitlab-ci</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">MAVEN_CLI_OPTS:</span> <span class="string">&quot;-s ./mvn-settings.xml --batch-mode&quot;</span></span><br><span class="line">  <span class="attr">SOFT_VERSION:</span> <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">  <span class="attr">SOFT_VERSION_EXT:</span> <span class="string">&#x27;alpha&#x27;</span></span><br><span class="line">  <span class="attr">NEW_SOFT_VERSION_EXT:</span> <span class="string">&#x27;beta&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">verify</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dockerpush</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pwd</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#单元测试</span></span><br><span class="line"><span class="attr">unit-test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">verify</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">$MAVEN_CLI_OPTS</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">runInDk</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#java编译打包docker镜像</span></span><br><span class="line"><span class="attr">java-package:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">runInDk</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">$&#123;CI_PIPELINE_ID&#125;</span> <span class="comment">#根据pipeline id缓存</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$&#123;CI_PROJECT_DIR&#125;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">  	<span class="comment">#registry 是仓库名,imagename是镜像名，CI_PIPELINE_ID是pipeline id</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">registry/imagename-$&#123;CI_PIPELINE_ID&#125;:$SOFT_VERSION</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#push镜像</span></span><br><span class="line"><span class="attr">docker-push:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">dockerpush</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">runInDk</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">$&#123;CI_PIPELINE_ID&#125;</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$&#123;CI_PROJECT_DIR&#125;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="comment">#registry 是仓库名,imagename是镜像名，CI_PIPELINE_ID是pipeline id</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">registry/imagename-$&#123;CI_PIPELINE_ID&#125;:$SOFT_VERSION</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<blockquote>
<p>更多参数操作，可以用：sudo docker exec gitlab-runner gitlab-runner register –help 进行查看</p>
</blockquote>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/7a7080f.html" data-id="cm5kxt8nm000wkku4c284gx4j" data-title="Gitlab-runner的容器化安装与使用" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Docker系列-docker远程访问" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/186d0ab9.html" class="article-date">
  <time class="dt-published" datetime="2020-10-23T09:31:44.000Z" itemprop="datePublished">2020-10-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/docker/">docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/186d0ab9.html">docker系列-docker远程访问</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="docker配置远程访问"><a href="#docker配置远程访问" class="headerlink" title="docker配置远程访问"></a>docker配置远程访问</h1><p>Docker Daemon 默认情况下是只允许本地访问的，不允许远程访问。本文将首先介绍 Docker Daemon 的连接方式，然后说明如何配置远程访问。即实现通过本地 docker 客户端访问远程主机的 docker 服务端，以此来监控远程主机上的 Docker 容器。</p>
<h2 id="如何配置"><a href="#如何配置" class="headerlink" title="如何配置:"></a>如何配置:</h2><p>有两种方式：</p>
<h3 id="第一种（推荐）"><a href="#第一种（推荐）" class="headerlink" title="第一种（推荐）"></a>第一种（推荐）</h3><p>是使用 <code>systemctl edit docker</code> 来调用文本编辑器修改指定的单元或单元实例，ubuntu 默认调用的是 nano 编辑器，不是很好用，如果不熟悉 nano 编辑器的操作可以使用 vim 编辑器。</p>
<p>主要也就是新建或修改 <code>/etc/systemd/system/docker.service.d/override.conf</code>，其内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">##Add this to the file for the docker daemon to use different ExecStart parameters (more things can be added here)</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br></pre></td></tr></table></figure>

<p>解释一下：</p>
<blockquote>
<p>默认情况下使用 systemd 时，docker.service 的设置为：<code>ExecStart=/usr/bin/dockerd -H fd://</code>，这将覆盖写到 daemon.json 中的任何 hosts 。通过在 override.conf 文件中将 ExecStart 仅仅定义为：<code>ExecStart=/usr/bin/dockerd</code>，这将会使用在 daemon.json 中设置的 hosts 。这个文件中的第一行<code>ExecStart=</code> 必须要有，因为它将用于清除默认的 ExecStart 参数。如果是修改 docker.service 的文件而不是创建 override.conf，那么下次 systemd 重启时，docker.service 文件也会被重新创建。</p>
</blockquote>
<p>然后在 <code>/etc/docker/daemon.json</code> （没有就新建一个，下文统一简称 daemon.json）中写入以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;hosts&quot;:[</span><br><span class="line">    &quot;unix:///var/run/docker.sock&quot;,</span><br><span class="line">    &quot;tcp://0.0.0.0:2375&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>该文件必须符合 json 规范写法，否则 Docker 将不能启动</p>
</blockquote>
<p>重新加载 daemon 并重启 docker 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line">$ <span class="built_in">sudo</span> systemctl restart docker.service</span><br></pre></td></tr></table></figure>

<p>检查端口监听：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> netstat -ntlp |grep dockerd</span><br><span class="line">tcp6       0      0 :::2375                 :::*                    LISTEN      2439/dockerd</span><br></pre></td></tr></table></figure>

<p>在远程主机上面通过 tcp socket 来访问本机的 Docker Daemon 服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker -H  192.168.205.10:2375 images</span><br><span class="line"></span><br><span class="line">$ docker -H  192.168.205.10:2375 ps</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中 192.168.1.130 是开放了远程访问的主机的 IP。</p>
</blockquote>
<h3 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h3><p>这种就很简单暴力，直接修改<code>/lib/systemd/system/docker.service</code>文件，注释掉默认的 ExecStart 并添加新的 ExecStart 配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ExecStart=/usr/bin/dockerd -H fd://</span><br><span class="line">ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock</span><br></pre></td></tr></table></figure>

<p>然后重启 docker.service：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl restart docker.service</span><br></pre></td></tr></table></figure>

<p>这样 dockerd 就开始监听 tcp 端口 2375 了</p>
<h1 id="Docker-与-Dockerd-的交互"><a href="#Docker-与-Dockerd-的交互" class="headerlink" title="Docker 与 Dockerd 的交互"></a>Docker 与 Dockerd 的交互</h1><p>Docker 客户端与 dockerd 之间就是通过 REST 的方式通信的。前面我们已经让 dockerd 监听 tcp 端口了，所以我们可以使用 curl 来代替 docker 客户端。这里我们简单的演示如何请求 dockerd 从 docker hub 上下载 hello-world 镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl &#x27;127.0.0.1:2375/images/create?fromImage=hello-world&amp;tag=latest&#x27; -X POST</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;status&quot;:&quot;Pulling from library/hello-world&quot;,&quot;id&quot;:&quot;latest&quot;&#125;</span><br><span class="line">&#123;&quot;status&quot;:&quot;Digest: sha256:8c5aeeb6a5f3ba4883347d3747a7249f491766ca1caa47e5da5dfcf6b9b717c0&quot;&#125;</span><br><span class="line">&#123;&quot;status&quot;:&quot;Status: Image is up to date for hello-world:latest&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>如果去看看 Engine API，你会发现其它的请求也都是用类似方式发送的，更多API可以参考官方文档，目前最新的版本是v1.40：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/v1.40/">https://docs.docker.com/engine/api/v1.40/</a></p>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/186d0ab9.html" data-id="cm5kxt8ne000gkku4dz2ogz66" data-title="docker系列-docker远程访问" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-docker系列-docker.sock探究" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/4d3646a8.html" class="article-date">
  <time class="dt-published" datetime="2020-10-23T09:31:44.000Z" itemprop="datePublished">2020-10-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/docker/">docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/4d3646a8.html">docker系列-docker.sock探究</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h1><p>搞清楚&#x2F;var&#x2F;run&#x2F;docker.sock参数的前提是了解docker的client+server架构，如下图</p>
<p><img src="/img/docker-cli-server.png"></p>
<p>可见在电脑上运行的docker由client和server组成，我们输入docker version命令实际上是通过客户端将请求发送到同一台电脑上的Doceker Daemon服务，由Docker Daemon返回信息，客户端收到信息后展示在控制台上。</p>
<p><strong>可是这个又跟docker.sock有什么关系呢？别急，我们再了解一下docker一些比较重要的组件</strong></p>
<h1 id="Docker-的主要组件"><a href="#Docker-的主要组件" class="headerlink" title="Docker 的主要组件"></a>Docker 的主要组件</h1><p>安装 docker ，其实是安装了 docker 客户端、dockerd 等一系列的组件，其中比较重要的有下面几个。</p>
<p><strong>Docker CLI(docker)</strong><br>docker 程序是一个客户端工具，用来把用户的请求发送给 docker daemon(dockerd)。</p>
<p>该程序的安装路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/docker</span><br></pre></td></tr></table></figure>

<p><strong>Dockerd</strong><br>docker daemon(dockerd)，一般也会被称为 docker engine。</p>
<p>该程序的安装路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/dockerd</span><br></pre></td></tr></table></figure>

<p><strong>Containerd</strong><br>在宿主机中管理完整的容器生命周期：容器镜像的传输和存储、容器的执行和管理、存储和网络等。</p>
<p>该程序的安装路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/docker-containerd</span><br></pre></td></tr></table></figure>

<p><strong>Containerd-shim</strong><br>它是 containerd 的组件，是容器的运行时载体，主要是用于剥离 containerd 守护进程与容器进程，引入shim，允许runc 在创建和运行容器之后退出，并将 shim 作为容器的父进程，而不是 containerd 作为父进程，这样做的目的是当 containerd 进程挂掉，由于 shim 还正常运行，因此可以保证容器不受影响。此外，shim 也可以收集和报告容器的退出状态，不需要 containerd 来 wait 容器进程。我们在 docker 宿主机上看到的 shim 也正是代表着一个个通过调用 containerd 启动的 docker 容器。</p>
<p>该程序的安装路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/docker-containerd-shim</span><br></pre></td></tr></table></figure>

<p><strong>RunC</strong><br>RunC 是一个轻量级的工具，它是用来运行容器的，容器作为 runC 的子进程开启，在不需要运行一个 Docker daemon 的情况下可以嵌入到其他各种系统，也就是说可以不用通过 docker 引擎，直接运行容器。docker是通过Containerd调用 runC 运行容器的</p>
<p>该程序的安装路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/docker-runc</span><br></pre></td></tr></table></figure>

<p><img src="/img/docker-component.png"></p>
<h1 id="从-hello-world-开始"><a href="#从-hello-world-开始" class="headerlink" title="从 hello world 开始"></a>从 hello world 开始</h1><p>我们通过hello-world镜像分析来进行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host docker]$ docker run hello-world</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image which runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/get-started/</span><br></pre></td></tr></table></figure>

<p>上面的输出信息指出，hello-world 容器的运行经历了如下四步：</p>
<ol>
<li>Docker 客户端向 docker daemon 发送请求</li>
<li>Docker daemon 从 Docker Hub 上拉取镜像</li>
<li>Docker daemon 使用镜像运行了一个容器并产生了输出</li>
<li>Docker daemon 把输出的内容发送给了 docker 客户端</li>
</ol>
<p>这是一个很抽象也很容器理解的过程，但是我们还想知道更多：docker daemon 是如何创建并运行容器的？<br>其实容器部分的操作和管理都被 dockerd 外包给 containerd 了，下图描述了运行一个容器时各个组件之间的关系：</p>
<p><img src="/img/dockerd.png"></p>
<h1 id="进入正题"><a href="#进入正题" class="headerlink" title="进入正题"></a>进入正题</h1><h2 id="Docker-Daemon-的连接方式"><a href="#Docker-Daemon-的连接方式" class="headerlink" title="Docker Daemon 的连接方式"></a>Docker Daemon 的连接方式</h2><ol>
<li><p><strong>UNIX 域套接字</strong></p>
<p>默认就是这种方式, 会生成一个 <code>/var/run/docker.sock</code> 文件, <code>UNIX</code> 域套接字用于本地进程之间的通讯, 这种方式相比于网络套接字效率更高, 但局限性就是只能被本地的客户端访问。</p>
</li>
<li><p><strong>tcp 端口监听</strong></p>
<p>服务端开启端口监听 <code>dockerd -H IP:PORT</code> , 客户端通过指定IP和端口访问服务端 <code>docker -H IP:PORT</code> 。通过这种方式, 任何人只要知道了你暴露的ip和端口就能随意访问你的docker服务了, 这是一件很危险的事, 因为docker的权限很高, 不法分子可以从这突破取得服务端宿主机的最高权限。</p>
</li>
</ol>
<h2 id="什么是unix-socket？"><a href="#什么是unix-socket？" class="headerlink" title="什么是unix socket？"></a>什么是unix socket？</h2><p>unix socket可以让一个程序通过类似处理一个文件的方式和另一个程序通信，这是一种进程间通信的方式（IPC）。<br> 当你在host上安装并且启动好docker，<code>docker daemon</code> 会自动创建一个socket文件并且保存在<code>/var/run/docker.sock</code>目录下。<code>docker daemon</code>监听着socket中即将到来的链接请求（可以通过<code>-H unix:///var/run/docker.sock</code>设定<code>docker daemon</code>监听的socket文件，-H参数还可以设定监听tcp:port或者其它的unix socket），当一个链接请求到来时，它会使用标准IO来读写数据。</p>
<p>docker.sock 是docker client 和docker daemon 在localhost进行通信的socket文件。<br> 可以直接call这个socket文件来拉去镜像，创建容器，启动容器等一系列操作。（其实就是直接call docker daemon API而不是通过docker client的方式去操控docker daemon）。</p>
<h2 id="官方说明"><a href="#官方说明" class="headerlink" title="官方说明"></a>官方说明</h2><p>我们从Docker Daemon进行，查看它的<a target="_blank" rel="noopener" href="https://docs.docker.com/v17.09/engine/reference/commandline/dockerd/#description">官方文档</a></p>
<p><img src="/img/dockerd-host.jpg"></p>
<p>上图是Docker Daemon的配置参数</p>
<p>翻译过来就是：–host&#x3D;[]<code>指定Docker守护程序将在何处侦听客户端连接。如果未指定，则默认为/var/run/docker.sock</code></p>
<p>所以docker客户端只要把请求发往这里，daemon就能收到并且做出响应。</p>
<p>按照上面的解释来推理：我们也可以向<code>/var/run/docker.sock</code>发送请求，也能达到<code>docker ps</code>、<code>docker images</code>这样的效果；</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><h3 id="1-查看镜像："><a href="#1-查看镜像：" class="headerlink" title="1.查看镜像："></a>1.查看镜像：</h3><ul>
<li><p>docker-cli方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@docker-host ~]$ docker images</span><br><span class="line">REPOSITORY                             TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">spring_demo                            latest              b7c0355e0a01        6 days ago          151MB</span><br><span class="line">nginx                                  latest              f35646e83998        2 weeks ago         133MB</span><br><span class="line">hello-world                            latest              bf756fb1ae65        9 months ago        13.3kB</span><br><span class="line">ampregistry:5000/sng-biz-base-alpine   2.1.0               54c2c81fffbe        17 months ago       137MB</span><br></pre></td></tr></table></figure>
</li>
<li><p>请求到Docker Daemon：</p>
<p>该请求返回的是json串，使用<code>| jq .</code>是为了格式化json,方便查看</p>
<blockquote>
<p>jq是linux里面的一个json格式化工具，如果没有安装可以去掉后面的<code>| jq .</code>代码，拷贝返回的json串手动格式化也可以</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>vagrant@docker-host ~<span class="punctuation">]</span>$ curl -s --unix-socket /var/run/docker.sock http<span class="punctuation">:</span>/images/json | jq .</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;VirtualSize&quot;</span><span class="punctuation">:</span> <span class="number">151316494</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Size&quot;</span><span class="punctuation">:</span> <span class="number">151316494</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Containers&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Created&quot;</span><span class="punctuation">:</span> <span class="number">1603359433</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:b7c0355e0a01f296e6ac94071b19c227839c8c19fecb2376dd8677ecbbe48017&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ParentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:4a5e4dd8fb964affb9750f01f66fb5f381988fcdbf8928902ce3f77b14fe990a&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RepoDigests&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;spring_demo:latest&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SharedSize&quot;</span><span class="punctuation">:</span> <span class="number">-1</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;VirtualSize&quot;</span><span class="punctuation">:</span> <span class="number">132861270</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Size&quot;</span><span class="punctuation">:</span> <span class="number">132861270</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Containers&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Created&quot;</span><span class="punctuation">:</span> <span class="number">1602578384</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:f35646e83998b844c3f067e5a2cff84cdf0967627031aeda3042d78996b68d35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;maintainer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ParentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RepoDigests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;nginx@sha256:ed7f815851b5299f616220a63edac69a4cc200e7f536a56e421988da82e44ed8&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;nginx:latest&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SharedSize&quot;</span><span class="punctuation">:</span> <span class="number">-1</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;VirtualSize&quot;</span><span class="punctuation">:</span> <span class="number">13336</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Size&quot;</span><span class="punctuation">:</span> <span class="number">13336</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Containers&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Created&quot;</span><span class="punctuation">:</span> <span class="number">1578014497</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ParentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RepoDigests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;hello-world@sha256:8c5aeeb6a5f3ba4883347d3747a7249f491766ca1caa47e5da5dfcf6b9b717c0&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;hello-world:latest&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SharedSize&quot;</span><span class="punctuation">:</span> <span class="number">-1</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-查看容器："><a href="#2-查看容器：" class="headerlink" title="2.查看容器："></a>2.查看容器：</h3><p>先运行一个nginx容器：<code>docker run --name mynginx -p 80:80 -d nginx</code></p>
<ul>
<li><p>docker-cli方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                NAMES</span><br><span class="line">919b34a22018        nginx               &quot;/docker-entrypoint.…&quot;   About a minute ago   Up About a minute   0.0.0.0:80-&gt;80/tcp   mynginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>请求Docker Daemon:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>vagrant@docker-host ~<span class="punctuation">]</span>$ curl -s --unix-socket /var/run/docker.sock http<span class="punctuation">:</span>/containers/json | jq .</span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Mounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;NetworkSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bridge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;DriverOpts&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;MacAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;02:42:ac:11:00:02&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;GlobalIPv6PrefixLen&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;GlobalIPv6Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;IPv6Gateway&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;IPAMConfig&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Links&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Aliases&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;NetworkID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;89d9f74c2884582696971298095e85c9c7df332a356c4b3a4dc09807eb6d457f&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;EndpointID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;53d712df1ad9bd9093b8492c1abace5fe72785cd80189aa4c64d7652dff38490&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Gateway&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.17.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;IPAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.17.0.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;IPPrefixLen&quot;</span><span class="punctuation">:</span> <span class="number">16</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;HostConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;NetworkMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Up 11 minutes&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;State&quot;</span><span class="punctuation">:</span> <span class="string">&quot;running&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;919b34a2201822a04fb1160c1c2369580d7b9ef9e7f1e9c77ad4da8761649fb9&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;/mynginx&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ImageID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:f35646e83998b844c3f067e5a2cff84cdf0967627031aeda3042d78996b68d35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/docker-entrypoint.sh nginx -g &#x27;daemon off;&#x27;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Created&quot;</span><span class="punctuation">:</span> <span class="number">1603879410</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PublicPort&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PrivatePort&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;IP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;maintainer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>如果去看看 Engine API，你会发现其它的请求也都是用类似方式发送的，更多API可以参考官方文档，目前最新的版本是v1.40：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/v1.40/">https://docs.docker.com/engine/api/v1.40/</a></p>
<p>至此，我们对docker的client、server架构有了清楚的认识：Docker Daemon相当于一个server，监听来自&#x2F;var&#x2F;run&#x2F;docker.sock的请求，然后做出各种响应，例如返回镜像列表，创建容器。</p>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/4d3646a8.html" data-id="cm5kxt8o4002bkku44rc40ox6" data-title="docker系列-docker.sock探究" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-设计模式-工厂方法模式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/89a20157.html" class="article-date">
  <time class="dt-published" datetime="2020-09-28T09:31:44.000Z" itemprop="datePublished">2020-09-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/89a20157.html">设计模式-工厂方法模式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><code>工厂方法模式</code>是为了弥补<code>简单工厂模式</code>的不足并且继承它的优点而延生出的一种设计模式，它能更好的符合开闭原则的要求。</p>
<h2 id="1-模式介绍"><a href="#1-模式介绍" class="headerlink" title="1 模式介绍"></a>1 模式介绍</h2><h3 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h3><p>工厂方法模式，又称工厂模式、多态工厂模式和虚拟构造器模式，通过定义工厂父类负责定义创建对象的公共接口，而子类则负责生成具体的对象。</p>
<h3 id="1-2-解决的问题"><a href="#1-2-解决的问题" class="headerlink" title="1.2 解决的问题"></a>1.2 解决的问题</h3><p>发现简单工厂模式存在一系列问题：<br>工厂类集中了所有实例（产品）的创建逻辑，一旦这个工厂不能正常工作，整个系统都会受到影响；<br>违背“开放 - 关闭原则”，一旦添加新产品就不得不修改工厂类的逻辑，这样就会造成工厂逻辑过于复杂。</p>
<h3 id="1-3-举个例子："><a href="#1-3-举个例子：" class="headerlink" title="1.3 举个例子："></a>1.3 举个例子：</h3><p>大众汽车公司想必大家都不陌生，它旗下也有不少汽车品牌。大众汽车公司就好比一个汽车工厂，负责生产和销售汽车。它可以为客户提供一个客户需要的汽车。但是，如果客户需要的汽车大众公司目前还没有，但是公司想要盈利，就必须为此而设计汽车，在这种情况下，大众公司就要新添加一种汽车，同时要修改公司内部的生产环境（也就是工厂类的代码）。这就是简单工厂模式的运行情况。简单而言，就是工厂类（汽车公司）什么都要干，要修改必须大动干戈。因而一定程度上违背了开闭原则。而工厂方法模式则不一样，大众汽车公司不在总公司生产汽车，而是成立分公司，收购别的公司，成立具有针对性的汽车工厂专门生产对应的汽车。若客户的大量需求得不到满足，则总公司就另外成立新的二级公司(新品牌汽车的工厂)生产汽车，从而在不修改具体工厂的情况下引进新的产品。正如大众集团的收购一样。以下为简单工厂模式和工厂方法模式的区别：</p>
<p>如果使用<code>简单工厂</code>是这样的模式<br><img src="/img/example_simplefactory.png"><br>如果使用<code>工厂方法</code>是这样的模式<br><img src="/img/example_factorymethod.png"></p>
<h3 id="1-4-模式组成"><a href="#1-4-模式组成" class="headerlink" title="1.4 模式组成"></a>1.4 模式组成</h3><table>
<thead>
<tr>
<th>组成（角色）</th>
<th>关系</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>抽象产品（Product）</td>
<td>具体产品的父类</td>
<td>描述具体产品的公共接口</td>
</tr>
<tr>
<td>具体产品（Concrete Product）</td>
<td>抽象产品的子类；工厂类创建的目标类</td>
<td>描述生产的具体产品</td>
</tr>
<tr>
<td>抽象工厂（Creator）</td>
<td>具体工厂的父类</td>
<td>描述具体工厂的公共接口</td>
</tr>
<tr>
<td>具体工厂（Concrete Creator）</td>
<td>抽象工厂的子类；被外界调用</td>
<td>描述具体工厂；实现FactoryMethod工厂方法创建产品的实例</td>
</tr>
</tbody></table>
<h2 id="2-实例讲解："><a href="#2-实例讲解：" class="headerlink" title="2 实例讲解："></a>2 实例讲解：</h2><p>手机专卖店<code>Store</code>卖手机，目前<code>Store</code>卖有两种手机，一个苹果手机，一个索尼手机，此时如果想从手机工厂进货“小米”手机，那么手机总工厂就必须修改内部实现</p>
<p>简单工厂模式由SimplePhoneFactory，集中获取不同的手机实例对象。<br><img src="/img/simplefactory.png"><br>工厂方法模式由PhoneFactory的两个实现，分别获取不同的手机实例对象。<br><img src="/img/factorymethod.png"></p>
<h3 id="2-1-使用步骤"><a href="#2-1-使用步骤" class="headerlink" title="2.1 使用步骤"></a>2.1 使用步骤</h3><p>步骤1： 创建抽象产品类 ，定义具体产品的公共抽象接口；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Phone</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 品牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String brand;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作系统</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String os;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 充电</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">charge</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOs</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> os;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOs</span><span class="params">(String os)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.os = os;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤2： 创建抽象工厂类，定义具体工厂的公共接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PhoneFactory</span> &#123;</span><br><span class="line">    Phone <span class="title function_">getPhone</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤3：创建具体工厂类（继承抽象工厂类），定义创建对应具体产品实例的方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 苹果手机工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplePhoneFactory</span> <span class="keyword">implements</span> <span class="title class_">PhoneFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApplePhone <span class="title function_">getPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplePhone</span> <span class="variable">applePhone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplePhone</span>();</span><br><span class="line">        applePhone.setBrand(<span class="string">&quot;Apple&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> applePhone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 索尼手机工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SonyPhoneFactory</span> <span class="keyword">implements</span> <span class="title class_">PhoneFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SonyPhone <span class="title function_">getPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SonyPhone</span> <span class="variable">sonyPhone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SonyPhone</span>();</span><br><span class="line">        sonyPhone.setBrand(<span class="string">&quot;Sony&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sonyPhone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更多其他手机工厂。。。</span></span><br></pre></td></tr></table></figure>

<p>步骤4： 创建具体产品类（继承抽象产品类）， 定义生产的具体产品；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 苹果手机</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplePhone</span> <span class="keyword">extends</span> <span class="title class_">Phone</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">charge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;普通充电&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 索尼手机</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SonyPhone</span> <span class="keyword">extends</span> <span class="title class_">Phone</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">charge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;快充&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤5：外界通过调用具体工厂类的方法，从而创建不同具体产品类的实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手机专卖店</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StoreB</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> PhoneFactory phoneFactory;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StoreB</span><span class="params">(PhoneFactory phoneFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.phoneFactory = phoneFactory;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 补充手机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">supplyPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Phone</span> <span class="variable">phone</span> <span class="operator">=</span> phoneFactory.getPhone();</span><br><span class="line">        <span class="comment">// 补充手机逻辑...</span></span><br><span class="line">        System.out.println(<span class="string">&quot;补充&quot;</span> + phone.getBrand() + <span class="string">&quot;手机完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StoreB</span> <span class="variable">storeB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StoreB</span>(<span class="keyword">new</span> <span class="title class_">SonyPhoneFactory</span>());</span><br><span class="line">        storeB.supplyPhone();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">补充Sony手机完成</span><br></pre></td></tr></table></figure>

<hr>
<p>优点：</p>
<ul>
<li>用户只需要知道具体工厂的名称就可得到所要的产品，无须知道产品的具体创建过程；</li>
<li>在系统增加新的产品时只需要添加具体产品类和对应的具体工厂类，无须对原工厂进行任何修改，满足开闭原则；</li>
</ul>
<p>缺点：</p>
<ul>
<li>每增加一个产品就要增加一个具体产品类和一个对应的具体工厂类，这增加了系统的复杂度</li>
</ul>
<p>总结：工厂模式可以说是简单工厂模式的进一步抽象和拓展，在保留了简单工厂的封装优点的同时，让扩展变得简单，让继承变得可行，增加了多态性的体现。</p>
<p>源码：<a target="_blank" rel="noopener" href="https://github.com/mrxccc/DesignPatterns">设计模式</a></p>
<blockquote>
<p>其他设计模式介绍：</p>
<p><a href="https://mrxccc.github.io//posts/89a20157.html">设计模式-工厂方法模式</a></p>
<p><a href="https://mrxccc.github.io//posts/5a86ebac.html">设计模式-抽象工厂模式</a></p>
<p><a href="https://mrxccc.github.io//posts/2a48474d.html">设计模式-建造者模式</a></p>
</blockquote>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/89a20157.html" data-id="cm5kxt8og003dkku4cb4f373u" data-title="设计模式-工厂方法模式" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker系列-容器相关操作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/e7ea293c.html" class="article-date">
  <time class="dt-published" datetime="2020-07-06T03:05:29.000Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/e7ea293c.html">Docker系列-容器的相关操作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>容器是 Docker 又一核心概念。<br>简单的说，容器是独立运行的一个或一组应用，以及它们的运行态环境。对应的，虚拟机可以理解为模拟运行的一整套操作系统（提供了运行态环境和其他系统环境）和跑在上面的应用。</p>
<h2 id="常用容器命令"><a href="#常用容器命令" class="headerlink" title="常用容器命令"></a>常用容器命令</h2><ul>
<li>列出当前所有容器：docker ps [OPTIONS]</li>
<li>新建并启动容器：docker run [OPTIONS] 镜像名或镜像ID [COMMAND] [ARG]</li>
<li>启动容器：docker start 容器ID或容器名</li>
<li>重启容器：docker restart 容器ID或容器名</li>
<li>停止容器：docker stop 容器ID或容器名</li>
<li>删除已容器：docker rm容器ID或容器名</li>
<li>查看容器日志：docker logs -f –t 容器名或容器ID</li>
</ul>
<h2 id="新建并启动容器"><a href="#新建并启动容器" class="headerlink" title="新建并启动容器"></a>新建并启动容器</h2><p>所需要的命令主要为 docker run。</p>
<p>例如，下面的命令输出一个 “Hello World”，之后终止容器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run ubuntu:14.04 /bin/echo &#x27;Hello world&#x27;</span><br><span class="line">Hello world</span><br></pre></td></tr></table></figure>
<p>这跟在本地直接执行 &#x2F;bin&#x2F;echo ‘hello world’ 几乎感觉不出任何区别。</p>
<h2 id="一行命令启动一个nginx"><a href="#一行命令启动一个nginx" class="headerlink" title="一行命令启动一个nginx"></a>一行命令启动一个nginx</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name my-nginx -p 80:80 -d nginx</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>–name nginx-test：容器名称。</li>
<li>-p 8080:80： 端口进行映射，将本地 8080 端口映射到容器内部的 -  80 端口。</li>
<li>-d nginx： 设置容器在在后台一直运行。</li>
</ul>
<h2 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h2><p>在使用 -d 参数时，容器启动后会进入后台。</p>
<p>某些时候需要进入容器进行操作，包括使用 docker attach 命令或 docker exec 命令，推荐大家使用 docker exec 命令，原因会在下面说明。</p>
<p>下面的命令则启动一个 bash 终端，允许用户进行交互。</p>
<h3 id="1-attach-命令"><a href="#1-attach-命令" class="headerlink" title="1.attach 命令"></a>1.attach 命令</h3><p>docker attach 是 Docker 自带的命令。下面示例如何使用该命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -dit ubuntu</span><br><span class="line">243c32535da7d142fb0e6df616a3c3ada0b8ab417937c853a9e1c251f499f550</span><br><span class="line"> </span><br><span class="line">$ docker container <span class="built_in">ls</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">243c32535da7        ubuntu:latest       <span class="string">&quot;/bin/bash&quot;</span>         18 seconds ago      Up 17 seconds                           nostalgic_hypatia</span><br><span class="line"> </span><br><span class="line">$ docker attach 243c</span><br><span class="line">root@243c32535da7:/#</span><br></pre></td></tr></table></figure>

<blockquote>
<p>！！！注意： 如果从这个 容器中 exit，会导致容器的停止。 如果想正常退出但不关闭容器，请按 Ctrl+P+Q进行退出容器</p>
</blockquote>
<h3 id="2-exec-命令"><a href="#2-exec-命令" class="headerlink" title="2.exec 命令"></a>2.exec 命令</h3><p>-i -t 参数<br>docker exec 后边可以跟多个参数，这里主要说明 -i -t 参数。</p>
<p>其中，-t 选项让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上， -i 则让容器的标准输入保持打开。<br>只用 -i 参数时，由于没有分配伪终端，界面没有我们熟悉的 Linux 命令提示符，但命令执行结果仍然可以返回。</p>
<p>当 -i -t 参数一起使用时，则可以看到我们熟悉的 Linux 命令提示符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -dit ubuntu</span><br><span class="line">69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6</span><br><span class="line"> </span><br><span class="line">$ docker container <span class="built_in">ls</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">69d137adef7a        ubuntu:latest       <span class="string">&quot;/bin/bash&quot;</span>         18 seconds ago      Up 17 seconds                           zealous_swirles</span><br><span class="line"> </span><br><span class="line">$ docker <span class="built_in">exec</span> -i 69d1 bash</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">$ docker <span class="built_in">exec</span> -it 69d1 bash</span><br><span class="line">root@69d137adef7a:/#</span><br></pre></td></tr></table></figure>

<p>如果从这个 容器 中 exit，不会导致容器的停止。这就是为什么推荐大家使用 docker exec 的原因。</p>
<p>更多参数说明请使用 docker exec –help 查看。</p>
<h2 id="Docker-删除容器"><a href="#Docker-删除容器" class="headerlink" title="Docker 删除容器"></a>Docker 删除容器</h2><p>可以使用 docker container rm 来删除一个处于终止状态的容器。例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker container <span class="built_in">rm</span>  trusting_newton</span><br><span class="line">trusting_newton</span><br></pre></td></tr></table></figure>
<p>如果要删除一个运行中的容器，可以添加 -f 参数。Docker 会发送 SIGKILL 信号给容器。</p>
<h2 id="清理所有处于终止状态的容器"><a href="#清理所有处于终止状态的容器" class="headerlink" title="清理所有处于终止状态的容器"></a>清理所有处于终止状态的容器</h2><p>用 docker container ls -a 命令可以查看所有已经创建的包括终止状态的容器，如果数量太多要一个个删除可能会很麻烦，用下面的命令可以清理掉所有处于终止状态的容器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container prune</span><br></pre></td></tr></table></figure>

<p>当利用 docker run 来创建容器时，Docker 在后台运行的标准操作包括：</p>
<ul>
<li>检查本地是否存在指定的镜像，不存在就从公有仓库下载</li>
<li>利用镜像创建并启动一个容器</li>
<li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li>
<li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li>
<li>从地址池配置一个 ip 地址给容器</li>
<li>执行用户指定的应用程序</li>
<li>执行完毕后容器被终止</li>
</ul>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/e7ea293c.html" data-id="cm5kxt8ng000mkku43jyx41sw" data-title="Docker系列-容器的相关操作" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Docker系列-镜像的相关操作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/cf1c7a25.html" class="article-date">
  <time class="dt-published" datetime="2020-07-06T03:05:29.000Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/cf1c7a25.html">Docker系列-镜像的相关操作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h2><p><a target="_blank" rel="noopener" href="https://hub.docker.com/explore/">Docker Hub</a> 上有大量的高质量的镜像可以用，这里我们就说一下怎么获取这些镜像。</p>
<p>从 Docker 镜像仓库获取镜像的命令是 <code>docker pull</code>。其命令格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]</span><br></pre></td></tr></table></figure>
<p>具体的选项可以通过 <code>docker pull --help</code> 命令看到，这里我们说一下镜像名称的格式。</p>
<ul>
<li>Docker 镜像仓库地址：地址的格式一般是 <code>&lt;域名/IP&gt;[:端口号]</code>。默认地址是 Docker Hub。</li>
<li>仓库名：如之前所说，这里的仓库名是两段式名称，即 <code>&lt;用户名&gt;/&lt;软件名&gt;</code>。对于 Docker Hub，如果不给出用户名，则默认为 library，也就是官方镜像。<br>比如：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull ubuntu:16.04</span><br><span class="line">16.04: Pulling from library/ubuntu</span><br><span class="line">bf5d46315322: Pull complete</span><br><span class="line">9f13e0ac480c: Pull complete</span><br><span class="line">e8988b5b3097: Pull complete</span><br><span class="line">40af181810e7: Pull complete</span><br><span class="line">e6f7c7e5c03e: Pull complete</span><br><span class="line">Digest: sha256:147913621d9cdea08853f6ba9116c2e27a3ceffecf3b492983ae97c3d643fbbe</span><br><span class="line">Status: Downloaded newer image for ubuntu:16.04</span><br></pre></td></tr></table></figure>

<h2 id="列出镜像"><a href="#列出镜像" class="headerlink" title="列出镜像"></a>列出镜像</h2><p>要想列出已经下载下来的镜像，可以使用  <code>docker image ls</code>或者 <code>docker images</code>命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ docker image ls</span><br><span class="line">REPOSITORY                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">flask-hello               latest              2921286533e1        17 minutes ago      924MB</span><br><span class="line">python                    3.6                 2dfb6d103623        5 days ago          914MB</span><br><span class="line">redis                     latest              987b78fc9e38        6 days ago          104MB</span><br><span class="line">caijiacheng0707/hello-c   latest              eca19e80e3c4        13 days ago         861kB</span><br><span class="line">wordpress                 latest              fd5f88e17621        2 weeks ago         541MB</span><br><span class="line">mysql                     5.7                 f965319e89de        3 weeks ago         448MB</span><br><span class="line">mysql                     latest              a7a67c95e831        3 weeks ago         541MB</span><br><span class="line">nginx                     latest              602e111c06b6        4 weeks ago         127MB</span><br><span class="line">python                    2.7-alpine          8579e446340f        4 weeks ago         71.1MB</span><br><span class="line">arm32v7/python            2.7-slim            b532061a7f5b        4 weeks ago         107MB</span><br></pre></td></tr></table></figure>
<p>列表包含了 仓库名、标签、镜像 ID、创建时间 以及 所占用的空间。</p>
<p>其中仓库名、标签在之前的基础概念章节已经介绍过了。镜像 ID 则是镜像的唯一标识，一个镜像可以对应多个标签。</p>
<h2 id="镜像体积"><a href="#镜像体积" class="headerlink" title="镜像体积"></a>镜像体积</h2><p>如果仔细观察，会注意到，这里标识的所占用空间和在 Docker Hub 上看到的镜像大小不同。比如，ubuntu:16.04 镜像大小，在这里是 127 MB，但是在 Docker Hub 显示的却是 50 MB。这是因为 Docker Hub 中显示的体积是压缩后的体积。在镜像下载和上传过程中镜像是保持着压缩状态的，因此 Docker Hub 所显示的大小是网络传输中更关心的流量大小。而 docker image ls 显示的是镜像下载到本地后，展开的大小，准确说，是展开后的各层所占空间的总和，因为镜像到本地后，查看空间的时候，更关心的是本地磁盘空间占用的大小。</p>
<p>另外一个需要注意的问题是，docker image ls 列表中的镜像体积总和并非是所有镜像实际硬盘消耗。由于 Docker 镜像是多层存储结构，并且可以继承、复用，因此不同镜像可能会因为使用相同的基础镜像，从而拥有共同的层。由于 Docker 使用 Union FS，相同的层只需要保存一份即可，因此实际镜像硬盘占用空间很可能要比这个列表镜像大小的总和要小的多。</p>
<p>你可以通过以下命令来便捷的查看镜像、容器、数据卷所占用的空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker system df</span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              10                  3                   2.59GB              2.418GB (93%)</span><br><span class="line">Containers          4                   2                   127.4kB             0B (0%)</span><br><span class="line">Local Volumes       5                   1                   478.1MB             478.1MB (100%)</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure>

<h3 id="过滤器参数"><a href="#过滤器参数" class="headerlink" title="过滤器参数"></a>过滤器参数</h3><p><code>docker images</code> 还支持强大的过滤器参数 –filter，或者简写 -f。之前我们已经看到了使用过滤器来列出虚悬镜像的用法，它还有更多的用法。比如，我们希望看到在 <code>mysql:5.7</code> 之后建立的镜像，可以用下面的命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker image ls -f since=mysql:5.7</span><br><span class="line">REPOSITORY                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">flask-hello               latest              2921286533e1        15 minutes ago      924MB</span><br><span class="line">python                    3.6                 2dfb6d103623        5 days ago          914MB</span><br><span class="line">redis                     latest              987b78fc9e38        6 days ago          104MB</span><br><span class="line">caijiacheng0707/hello-c   latest              eca19e80e3c4        13 days ago         861kB</span><br><span class="line">wordpress                 latest              fd5f88e17621        2 weeks ago         541MB</span><br></pre></td></tr></table></figure>

<p>想查看某个位置之前的镜像也可以，只需要把 <code>since</code> 换成 <code>before</code> 即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker image ls -f before=mysql:5.7</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">mysql               latest              a7a67c95e831        3 weeks ago         541MB</span><br><span class="line">nginx               latest              602e111c06b6        4 weeks ago         127MB</span><br><span class="line">python              2.7-alpine          8579e446340f        4 weeks ago         71.1MB</span><br><span class="line">arm32v7/python      2.7-slim            b532061a7f5b        4 weeks ago         107MB</span><br></pre></td></tr></table></figure>

<p>此外，如果镜像构建时，定义了 LABEL，还可以通过 LABEL 来过滤。<br>默认情况下，docker image ls 会输出一个完整的表格，但是我们并非所有时候都会需要这些内容。比如，刚才删除虚悬镜像的时候，我们需要利用 docker image ls 把所有的虚悬镜像的 ID 列出来，然后才可以交给 docker image rm 命令作为参数来删除指定的这些镜像，这个时候就用到了 -q 参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker image ls -q</span><br><span class="line">5f515359c7f8</span><br><span class="line">05a60462f8ba</span><br><span class="line">fe9198c04d62</span><br><span class="line">00285df0df87</span><br><span class="line">f753707788c5</span><br><span class="line">f753707788c5</span><br><span class="line">1e0c3dd64ccd</span><br></pre></td></tr></table></figure>
<p>–filter 配合 -q 产生出指定范围的 ID 列表，然后送给另一个 docker 命令作为参数，从而针对这组实体成批的进行某种操作的做法在 Docker 命令行使用过程中非常常见，不仅仅是镜像，将来我们会在各个命令中看到这类搭配以完成很强大的功能。因此每次在文档看到过滤器后，可以多注意一下它们的用法。</p>
<p>另外一些时候，我们可能只是对表格的结构不满意，希望自己组织列；或者不希望有标题，这样方便其它程序解析结果等，这就用到了 Go 的模板语法。</p>
<p>比如，下面的命令会直接列出镜像结果，并且只包含镜像ID和仓库名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker image ls --format &quot;&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Repository&#125;&#125;&quot;</span><br><span class="line">5f515359c7f8: redis</span><br><span class="line">05a60462f8ba: nginx</span><br><span class="line">fe9198c04d62: mongo</span><br><span class="line">00285df0df87: &lt;none&gt;</span><br><span class="line">f753707788c5: ubuntu</span><br><span class="line">f753707788c5: ubuntu</span><br><span class="line">1e0c3dd64ccd: ubuntu</span><br></pre></td></tr></table></figure>
<p>或者打算以表格等距显示，并且有标题行，和默认一样，不过自己定义列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">$ docker image ls --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Repository&#125;&#125;\t&#123;&#123;.Tag&#125;&#125;&quot;</span><br><span class="line">IMAGE ID            REPOSITORY          TAG</span><br><span class="line">5f515359c7f8        redis               latest</span><br><span class="line">05a60462f8ba        nginx               latest</span><br><span class="line">fe9198c04d62        mongo               3.2</span><br><span class="line">00285df0df87        &lt;none&gt;              &lt;none&gt;</span><br><span class="line">f753707788c5        ubuntu              16.04</span><br><span class="line">f753707788c5        ubuntu              latest</span><br><span class="line">1e0c3dd64ccd        ubuntu              14.04</span><br></pre></td></tr></table></figure>
<h2 id="Docker-删除本地镜像"><a href="#Docker-删除本地镜像" class="headerlink" title="Docker 删除本地镜像"></a>Docker 删除本地镜像</h2><p>如果要删除本地的镜像，可以使用 docker image rm 命令，其格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image rm [选项] &lt;镜像1&gt; [&lt;镜像2&gt; ...]</span><br></pre></td></tr></table></figure>
<p>像其它可以承接多个实体的命令一样，可以使用 docker image ls -q 来配合使用 docker image rm，这样可以成批的删除希望删除的镜像。我们在“镜像列表”章节介绍过很多过滤镜像列表的方式都可以拿过来使用。</p>
<p>比如，我们需要删除所有仓库名为 redis 的镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image rm $(docker image ls -q redis)</span><br></pre></td></tr></table></figure>
<p>或者删除所有在 <code>mysql:5.7</code> 之前的镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image rm $(docker image ls -q -f before=mysql:5.7)</span><br></pre></td></tr></table></figure>

<h2 id="虚悬镜像"><a href="#虚悬镜像" class="headerlink" title="虚悬镜像"></a>虚悬镜像</h2><p>有时候在镜像列表中，还可以看到一个特殊的镜像，这个镜像既没有仓库名，也没有标签，均为 <none>。：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;none&gt;               &lt;none&gt;              00285df0df87        5 days ago          342 MB</span><br></pre></td></tr></table></figure>
<p>一般有两种会产生虚悬镜像：<br><code>dockers pull</code>: 原来有一个镜像 mongo:3.2，随着官方镜像维护，发布了新版本后，重新 docker pull mongo:3.2 时，mongo:3.2 这个镜像名被转移到了新下载的镜像身上，而旧的镜像上的这个名称则被取消，从而成为了 <none>。<br><code>docker build</code>:也同样可以导致这种现象。由于新旧镜像同名，旧镜像名称被取消，从而出现仓库名、标签均为 <none> 的镜像。这类无标签镜像也被称为 虚悬镜像(dangling image) </p>
<h3 id="显示虚悬镜像"><a href="#显示虚悬镜像" class="headerlink" title="显示虚悬镜像"></a>显示虚悬镜像</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker image ls -f dangling=true</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">&lt;none&gt;              &lt;none&gt;              00285df0df87        5 days ago          342 MB</span><br></pre></td></tr></table></figure>
<h3 id="删除虚悬镜像"><a href="#删除虚悬镜像" class="headerlink" title="删除虚悬镜像"></a>删除虚悬镜像</h3><p>一般来说，虚悬镜像已经失去了存在的价值，是可以随意删除的，可以用下面的命令删除。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi $(docker images -q -f dangling=true)</span><br></pre></td></tr></table></figure>

<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/cf1c7a25.html" data-id="cm5kxt8nj000rkku4adek73g2" data-title="Docker系列-镜像的相关操作" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Docker系列-docker简介" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/e4de3745.html" class="article-date">
  <time class="dt-published" datetime="2020-06-29T10:18:13.000Z" itemprop="datePublished">2020-06-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/posts/e4de3745.html">Docker系列-docker的三个基本概念</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Docker-三个基本概念"><a href="#Docker-三个基本概念" class="headerlink" title="Docker 三个基本概念"></a>Docker 三个基本概念</h2><p>镜像（Image）<br>容器（Container）<br>仓库（Repository）</p>
<p>Docker 引擎是一个包含以下主要组件的客户端服务器应用程序。</p>
<p>一种服务器，它是一种称为守护进程并且长时间运行的程序。<br>REST API用于指定程序可以用来与守护进程通信的接口，并指示它做什么。<br>一个有命令行界面 (CLI) 工具的客户端。<br>Docker 引擎组件的流程如下图所示：</p>
<p><img src="https://img-blog.csdnimg.cn/20200629180402432.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1hjX3hkZA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="2-Docker-系统架构"><a href="#2-Docker-系统架构" class="headerlink" title="2 Docker 系统架构"></a>2 Docker 系统架构</h2><p>Docker 使用客户端-服务器 (C&#x2F;S) 架构模式，使用远程 API 来管理和创建 Docker 容器。</p>
<p>Docker 容器通过 Docker 镜像来创建。</p>
<p>容器与镜像的关系类似于面向对象编程中的对象与类。</p>
<table>
<thead>
<tr>
<th>Docker</th>
<th>面向对象</th>
</tr>
</thead>
<tbody><tr>
<td>容器</td>
<td>对象</td>
</tr>
<tr>
<td>镜像</td>
<td>类</td>
</tr>
</tbody></table>
<h2 id="3-Image-镜像"><a href="#3-Image-镜像" class="headerlink" title="3 Image (镜像)"></a>3 Image (镜像)</h2><p>那么镜像到底是什么呢？</p>
<p>Docker 镜像可以看作是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。镜像不包含任何动态数据，其内容在构建之后也不会被改变。(每个镜像都由很多层次构成，Docker 使用Union FS将这些不同的层结合到一个镜像中去)</p>
<p>镜像（Image）就是一堆只读层（read-only layer）的统一视角，也许这个定义有些难以理解，下面的这张图能够帮助读者理解镜像的定义。<br><img src="https://img-blog.csdnimg.cn/202006291807153.png" alt="在这里插入图片描述"><br>从左边我们看到了多个只读层，它们重叠在一起。除了最下面一层，其它层都会有一个指针指向下一层。这些层是Docker 内部的实现细节，并且能够在主机的文件系统上访问到。统一文件系统 (union file system) 技术能够将不同的层整合成一个文件系统，为这些层提供了一个统一的视角，这样就隐藏了多层的存在，在用户的角度看来，只存在一个文件系统。我们可以在图片的右边看到这个视角的形式。</p>
<p>Container (容器)<br>容器 (container) 的定义和镜像 (image) 几乎一模一样，也是一堆层的统一视角，唯一区别在于容器的最上面那一层是可读可写的。<br><img src="https://img-blog.csdnimg.cn/20200629180804694.png" alt="在这里插入图片描述"><br>由于容器的定义并没有提及是否要运行容器，所以实际上，容器 &#x3D; 镜像 + 读写层。</p>
<h2 id="4-Repository-仓库"><a href="#4-Repository-仓库" class="headerlink" title="4 Repository (仓库)"></a>4 Repository (仓库)</h2><p>Docker 仓库是集中存放镜像文件的场所。镜像构建完成后，可以很容易的在当前宿主上运行，但是， 如果需要在其它服务器上使用这个镜像，我们就需要一个集中的存储、分发镜像的服务，Docker Registry (仓库注册服务器)就是这样的服务。有时候会把仓库 (Repository) 和仓库注册服务器 (Registry) 混为一谈，并不严格区分。Docker 仓库的概念跟 Git 类似，注册服务器可以理解为 GitHub 这样的托管服务。实际上，一个 Docker Registry 中可以包含多个仓库 (Repository) ，每个仓库可以包含多个标签 (Tag)，每个标签对应着一个镜像。所以说，镜像仓库是 Docker 用来集中存放镜像文件的地方类似于我们之前常用的代码仓库。</p>
<p>通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本 。我们可以通过&lt;仓库名&gt;:&lt;标签&gt;的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 latest 作为默认标签.。</p>
<p>仓库又可以分为两种形式：</p>
<ul>
<li>public(公有仓库)</li>
<li>private(私有仓库)</li>
</ul>
<p>Docker Registry 公有仓库是开放给用户使用、允许用户管理镜像的 Registry 服务。一般这类公开服务允许用户免费上传、下载公开的镜像，并可能提供收费服务供用户管理私有镜像。</p>
<p>除了使用公开服务外，用户还可以在本地搭建私有 Docker Registry 。Docker 官方提供了 Docker Registry 镜像，可以直接使用做为私有 Registry 服务。当用户创建了自己的镜像之后就可以使用 push 命令将它上传到公有或者私有仓库，这样下次在另外一台机器上使用这个镜像时候，只需要从仓库上 pull 下来就可以了。</p>
<p>我们主要把 Docker 的一些常见概念如 Image ， Container ， Repository 做了详细的阐述，也从传统虚拟化方式的角度阐述了 docker 的优势，我们从下图可以直观地看到 Docker 的架构：<br><img src="https://img-blog.csdnimg.cn/20200629181233919.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1hjX3hkZA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>Docker 使用 C&#x2F;S 结构，即客户端&#x2F;服务器体系结构。 Docker 客户端与 Docker 服务器进行交互，Docker服务端负责构建、运行和分发 Docker 镜像。 Docker 客户端和服务端可以运行在一台机器上，也可以通过 RESTful 、 stock 或网络接口与远程 Docker 服务端进行通信。</p>
<p>最后通过一个表格总结一下：</p>
<table>
<thead>
<tr>
<th>标题</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>镜像(Images)</td>
<td>Docker 镜像是用于创建 Docker 容器的模板。</td>
</tr>
<tr>
<td>容器(Container)</td>
<td>容器是独立运行的一个或一组应用。</td>
</tr>
<tr>
<td>客户端(Client)</td>
<td>Docker 客户端通过命令行或者其他工具使用 Docker API (<a target="_blank" rel="noopener" href="https://docs.docker.com/reference/api/docker_remote_api">https://docs.docker.com/reference/api/docker_remote_api</a>) 与 Docker 的守护进程通信。</td>
</tr>
<tr>
<td>主机(Host)</td>
<td>一个物理或者虚拟的机器用于执行 Docker 守护进程和容器。</td>
</tr>
<tr>
<td>仓库(Registry)</td>
<td>Docker 仓库用来保存镜像，可以理解为代码控制中的代码仓库。Docker Hub(<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a>) 提供了庞大的镜像集合供使用。</td>
</tr>
<tr>
<td>Docker Machine</td>
<td>Docker Machine是一个简化Docker安装的命令行工具，通过一个简单的命令行即可在相应的平台上安装Docker，比如VirtualBox、 Digital Ocean、Microsoft Azure。</td>
</tr>
</tbody></table>
<p>更多精彩内容：<a href="https://mrxccc.github.io/">mrxccc</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mrxccc.github.io/posts/e4de3745.html" data-id="cm5kxt8nh000nkku43kvy82h2" data-title="Docker系列-docker的三个基本概念" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; 上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/IC/">IC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java8%E6%96%B0%E7%89%B9%E6%80%A7/">Java8新特性</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Sonarquber/">Sonarquber</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/dfinity/">dfinity</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gitlab-ci/">gitlab-ci</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8C%96%E5%88%B0%E4%BA%91%E5%8E%9F%E7%94%9F/">从服务化到云原生</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A1%A8%E6%A0%BC%E5%A4%84%E7%90%86/">表格处理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/IC/" rel="tag">IC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/POI/" rel="tag">POI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dfinity/" rel="tag">dfinity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/easyexcel/" rel="tag">easyexcel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag">区块链</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E9%9D%A2/" rel="tag">知识面</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A1%A8%E6%A0%BC%E5%A4%84%E7%90%86/" rel="tag">表格处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/IC/" style="font-size: 20px;">IC</a> <a href="/tags/POI/" style="font-size: 13.33px;">POI</a> <a href="/tags/dfinity/" style="font-size: 10px;">dfinity</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/easyexcel/" style="font-size: 10px;">easyexcel</a> <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" style="font-size: 13.33px;">区块链</a> <a href="/tags/%E7%9F%A5%E8%AF%86%E9%9D%A2/" style="font-size: 10px;">知识面</a> <a href="/tags/%E8%A1%A8%E6%A0%BC%E5%A4%84%E7%90%86/" style="font-size: 13.33px;">表格处理</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 16.67px;">设计模式</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 10px;">转载</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">一月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">十一月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/posts/undefined.html">solidity语言特性之数据类型</a>
          </li>
        
          <li>
            <a href="/posts/66a907b1.html">Gitlab-CICD最简单明了的入门教程</a>
          </li>
        
          <li>
            <a href="/posts/f73eb048.html">设计模式-拦截过滤器</a>
          </li>
        
          <li>
            <a href="/posts/fc25c4a4.html">IC中的账户及相关操作</a>
          </li>
        
          <li>
            <a href="/posts/f78d4d0c.html">IC上出色的基础设施（持续更新）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 mrxccc<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>